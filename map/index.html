<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nimea Interactive Map</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;700&family=EB+Garamond:wght@400;500;700&display=swap&subset=latin-ext">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="map-header">
        <nav class="map-nav">
            <a href="../" class="nav-link">Home</a>
            <a href="../wiki/" class="nav-link">Wiki</a>
            <h1 class="map-title">Nimea Interactive Map</h1>
        </nav>
    </header>
    
    <div id="map"></div>

    <!-- Route sidebar reopen button -->
    <button id="reopen-route-sidebar" class="reopen-route-btn hidden" title="Open Route Planner">
        ğŸ—ºï¸
    </button>

    <div class="map-legend hidden" id="map-legend" role="region" aria-label="Map Legend">
        <h4>Legend</h4>
        <ul>
            <li><span class="legend-swatch legend-road"></span> Road</li>
            <li><span class="legend-swatch legend-difficult"></span> Difficult Terrain</li>
            <li><span class="legend-swatch legend-unpassable"></span> Unpassable Terrain</li>
            <li><span class="legend-swatch legend-route"></span> Route Path</li>
        </ul>
        <div class="legend-note">Scale: 115 px = 100 km</div>
    </div>

    <!-- Overlay segmented control will appear through existing container -->

    <div class="sidebar left-sidebar" id="route-sidebar">
        <button id="close-route-sidebar" class="sidebar-close-btn">&times;</button>
        <h2>Route Planner</h2>
        <div id="route-stops"></div>
        <div id="route-summary"></div>
    </div>

    <div class="sidebar right-sidebar" id="info-sidebar">
        <button id="close-info-sidebar">&times;</button>
        <div id="info-content"></div>
    </div>

    <!-- DM Mode Marker Creation Form -->
    <div class="modal hidden" id="marker-creation-modal">
        <div class="modal-content">
            <h3>Create New Marker</h3>
            <form id="marker-form">
                <input type="hidden" id="marker-lat">
                <input type="hidden" id="marker-lng">
                <div class="form-group">
                    <label for="marker-name">Name *</label>
                    <input type="text" id="marker-name" name="marker-name" required>
                </div>
                
                <div class="form-group">
                    <label for="marker-id">ID *</label>
                    <input type="text" id="marker-id" name="marker-id" required>
                    <small>Auto-generated from name, but you can edit</small>
                </div>
                
                <div class="form-group">
                    <label for="marker-type">Type</label>
                    <select id="marker-type" name="marker-type">
                        <option value="city">City</option>
                        <option value="town">Town</option>
                        <option value="village">Village</option>
                        <option value="fortress">Fortress</option>
                        <option value="ruin">Ruin</option>
                        <option value="landmark">Landmark</option>
                        <option value="dungeon">Dungeon</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="marker-icon">Custom Icon</label>
                    <div class="icon-input-container">
                        <input type="text" id="marker-icon" name="marker-icon" placeholder="ğŸ° or âš”ï¸ or leave empty for default" maxlength="10">
                        <div class="icon-suggestions">
                            <span class="icon-option" data-icon="ğŸ°">ğŸ°</span>
                            <span class="icon-option" data-icon="ğŸ˜ï¸">ğŸ˜ï¸</span>
                            <span class="icon-option" data-icon="ğŸ›ï¸">ğŸ›ï¸</span>
                            <span class="icon-option" data-icon="âš”ï¸">âš”ï¸</span>
                            <span class="icon-option" data-icon="ğŸ—¡ï¸">ğŸ—¡ï¸</span>
                            <span class="icon-option" data-icon="ğŸ›¡ï¸">ğŸ›¡ï¸</span>
                            <span class="icon-option" data-icon="ğŸ´â€â˜ ï¸">ğŸ´â€â˜ ï¸</span>
                            <span class="icon-option" data-icon="â­">â­</span>
                            <span class="icon-option" data-icon="ğŸ’">ğŸ’</span>
                            <span class="icon-option" data-icon="ğŸ—»">ğŸ—»</span>
                            <span class="icon-option" data-icon="ğŸŒ‹">ğŸŒ‹</span>
                            <span class="icon-option" data-icon="ğŸ”ï¸">ğŸ”ï¸</span>
                        </div>
                    </div>
                    <small>Click an icon above or type your own emoji/symbol</small>
                </div>
                
                <div class="form-group">
                    <label for="marker-icon-url">Or Custom Image URL</label>
                    <input type="url" id="marker-icon-url" name="marker-icon-url" placeholder="https://example.com/icon.png">
                    <small>Use an image URL for custom PNG/JPG icons (overrides emoji if both provided)</small>
                </div>
                
                <div class="form-group">
                    <label for="marker-faction">Faction</label>
                    <input type="text" id="marker-faction" name="marker-faction" placeholder="e.g., Empire of Aurelius">
                </div>
                
                <div class="form-group">
                    <label for="marker-summary">Summary *</label>
                    <textarea id="marker-summary" name="marker-summary" rows="3" required></textarea>
                </div>

                <div class="form-group">
                    <label for="marker-wiki-slug">Wiki Slug Override</label>
                    <input type="text" id="marker-wiki-slug" name="marker-wiki-slug" placeholder="Optional: e.g., empire-of-aurelius">
                    <small>If provided, links directly to /wiki/&lt;slug&gt;/ . Otherwise auto-generated.</small>
                </div>
                
                <div class="form-group">
                    <label for="marker-coordinates">Coordinates</label>
                    <input type="text" id="marker-coordinates" readonly>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="marker-public" name="marker-public" checked>
                        Public (visible to players)
                    </label>
                </div>
                
                <div class="form-actions">
                    <button type="button" id="cancel-marker">Cancel</button>
                    <button type="submit" id="save-marker">Create Marker</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Import Modal for DM Mode -->
    <div class="modal hidden" id="bulk-import-modal">
        <div class="modal-content">
            <h3>Bulk Import Markers</h3>
            <div class="form-group">
                <label for="csv-input">CSV Data</label>
                <textarea id="csv-input" rows="10" placeholder="name,x,y,type,faction,summary,public
Varkas,1234,987,city,Kuruntar,Ancient capital city,true
Thornhold,2000,1500,fortress,Empire,Mountain fortress,true"></textarea>
                <small>Format: name,x,y,type,faction,summary,public (header row optional)</small>
            </div>
            
            <div class="form-group">
                <label for="csv-file">Or upload CSV file:</label>
                <input type="file" id="csv-file" accept=".csv" />
            </div>
            
            <div class="form-actions">
                <button type="button" id="cancel-import">Cancel</button>
                <button type="button" id="process-import">Import Markers</button>
            </div>
        </div>
    </div>

    <!-- Terrain Type Selection Modal -->
    <div class="modal hidden" id="terrain-type-modal">
        <div class="modal-content">
            <h3>Select Terrain Type</h3>
            <div class="terrain-options">
                <button type="button" class="terrain-btn road-btn" data-type="road">
                    ğŸ›¤ï¸ Road<br>
                    <small>Faster travel</small>
                </button>
                <button type="button" class="terrain-btn difficult-btn" data-type="difficult">
                    ğŸ”ï¸ Difficult<br>
                    <small>Slower travel</small>
                </button>
                <button type="button" class="terrain-btn forest-btn" data-type="forest">
                    ğŸŒ² Forest<br>
                    <small>Moderate difficulty</small>
                </button>
                <button type="button" class="terrain-btn unpassable-btn" data-type="unpassable">
                    ğŸš« Unpassable<br>
                    <small>Impassable terrain</small>
                </button>
            </div>
            <div class="form-actions">
                <button type="button" id="cancel-terrain">Cancel</button>
            </div>
        </div>
    </div>

    <div class="leaflet-top leaflet-right">
        <div class="leaflet-control-layers leaflet-control" id="overlay-toggles">
            <div class="overlay-segmented" role="group" aria-label="Overlay visibility">
                <button type="button" data-mode="both" class="active" aria-pressed="true"><span>Both</span></button>
                <button type="button" data-mode="regions" aria-pressed="false"><span>Regions</span></button>
                <button type="button" data-mode="borders" aria-pressed="false"><span>Borders</span></button>
                <button type="button" data-mode="none" aria-pressed="false"><span>None</span></button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <!-- Netlify Identity for DM authentication -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="config.js"></script>
    <script src="git-client.js"></script>
    <script src="js/leaflet.tappable.js"></script>
    <!-- Routing Module Components (load before main routing.js) -->
    <script src="js/routing/terrain-utils.js"></script>
    <script src="js/routing/pathfinding.js"></script>
    <script src="js/routing/graph-builder.js"></script>
    <script src="js/routing/path-naturalizer.js"></script>
    <script src="js/routing/visualizer.js"></script>
    <!-- New Modular Routing Components -->
    <script src="js/routing/route-core.js"></script>
    <script src="js/routing/waypoint-manager.js"></script>
    <script src="js/routing/route-ui.js"></script>
    <script src="js/routing/route-drag-drop.js"></script>
    <script src="js/routing.js"></script>
    <!-- DM Module Components -->
    <script src="js/dm-controls.js"></script>
    <script src="js/dm-modals.js"></script>
    <script src="js/dm.js"></script>
    <!-- End DM Module Components -->
    <script src="js/ui.js"></script>
    <script src="js/direct-touch.js"></script>
    <script src="js/markers.js"></script>
    <script src="js/terrain.js"></script>
    <script src="map.js"></script>
</body>
</html>
